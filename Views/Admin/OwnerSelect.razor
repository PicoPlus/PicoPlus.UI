@page "/admin/owner-select"
@layout Components.Layout.AdminLayout
@using PicoPlus.Services.Admin
@using PicoPlus.State.Admin
@using PicoPlus.Models.Admin
@inject AdminOwnerService OwnerService
@inject AdminStateService AdminState
@inject NavigationManager Navigation
@inject ILogger<OwnerSelect> Logger

<PageTitle>?????? ???? - ??? ??????</PageTitle>

<div class="owner-select-page">
    <div class="page-header mb-4">
        <h2 class="mb-2">
            <i class="bi bi-person-gear me-2"></i>
            ?????? ???? HubSpot
        </h2>
        <p class="text-muted">
            ???? ?????? ? ?????? ???????? ????? ?? ???? ?? ?? ???? ???? ????? ?? ????? ?? ?????? ????.
        </p>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">?? ??? ????????...</span>
            </div>
            <p class="mt-3 text-muted">?? ??? ?????? ???? ??????...</p>
        </div>
    }
    else
    {
        <!-- Search Section -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input 
                                type="text" 
                                class="form-control" 
                                placeholder="????? ?? ????? ?? ???..."
                                @bind="searchTerm"
                                @bind:event="oninput"
                                @onkeyup="HandleSearch" />
                            @if (!string.IsNullOrWhiteSpace(searchTerm))
                            {
                                <button class="btn btn-outline-secondary" @onclick="ClearSearch">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            }
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary btn-lg w-100" @onclick="LoadOwners">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            ????????? ????
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Owners -->
        @if (recentOwners.Any())
        {
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        ?????? ????
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        @foreach (var owner in recentOwners)
                        {
                            <div class="col-md-6 col-lg-4">
                                <div class="owner-card recent @(selectedOwner?.Id == owner.Id ? "selected" : "")" 
                                     @onclick="() => SelectOwner(owner)">
                                    <div class="owner-avatar">
                                        <i class="bi bi-person-circle"></i>
                                    </div>
                                    <div class="owner-info">
                                        <div class="owner-name">@owner.FullName</div>
                                        <div class="owner-email">@owner.Email</div>
                                    </div>
                                    @if (selectedOwner?.Id == owner.Id)
                                    {
                                        <div class="selected-badge">
                                            <i class="bi bi-check-circle-fill"></i>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- All Owners List -->
        <div class="card">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>
                        ??? ?????? (@filteredOwners.Count)
                    </h5>
                    @if (selectedOwner != null)
                    {
                        <button class="btn btn-success" @onclick="ConfirmSelection">
                            <i class="bi bi-check-lg me-2"></i>
                            ????? ? ????? ?? ???????
                        </button>
                    }
                </div>
            </div>
            <div class="card-body">
                @if (!filteredOwners.Any())
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="mt-3 text-muted">??? ????? ???? ???</p>
                    </div>
                }
                else
                {
                    <div class="row g-3">
                        @foreach (var owner in filteredOwners)
                        {
                            <div class="col-md-6 col-lg-4">
                                <div class="owner-card @(selectedOwner?.Id == owner.Id ? "selected" : "")" 
                                     @onclick="() => SelectOwner(owner)">
                                    <div class="owner-avatar">
                                        <i class="bi bi-person-circle"></i>
                                    </div>
                                    <div class="owner-info">
                                        <div class="owner-name">@owner.FullName</div>
                                        <div class="owner-email">@owner.Email</div>
                                        <div class="owner-meta">
                                            <small class="text-muted">
                                                <i class="bi bi-calendar3 me-1"></i>
                                                @owner.CreatedAt.ToString("yyyy-MM-dd")
                                            </small>
                                        </div>
                                    </div>
                                    @if (selectedOwner?.Id == owner.Id)
                                    {
                                        <div class="selected-badge">
                                            <i class="bi bi-check-circle-fill"></i>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private List<HubSpotOwner> allOwners = new();
    private List<HubSpotOwner> filteredOwners = new();
    private List<HubSpotOwner> recentOwners = new();
    private HubSpotOwner? selectedOwner;

    protected override async Task OnInitializedAsync()
    {
        await LoadOwners();
        
        // Load admin state
        await AdminState.InitializeAsync();
        selectedOwner = AdminState.GetSelectedOwner();
        recentOwners = AdminState.Context.RecentOwners;
    }

    private async Task LoadOwners()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            allOwners = await OwnerService.GetAllOwnersAsync();
            filteredOwners = allOwners;
            Logger.LogInformation("Loaded {Count} owners", allOwners.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading owners");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleSearch()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredOwners = allOwners;
        }
        else
        {
            var term = searchTerm.Trim().ToLower();
            filteredOwners = allOwners
                .Where(o => 
                    o.Email.ToLower().Contains(term) ||
                    o.FirstName.ToLower().Contains(term) ||
                    o.LastName.ToLower().Contains(term) ||
                    o.FullName.ToLower().Contains(term))
                .ToList();
        }
    }

    private void ClearSearch()
    {
        searchTerm = string.Empty;
        filteredOwners = allOwners;
    }

    private async Task SelectOwner(HubSpotOwner owner)
    {
        selectedOwner = owner;
        await AdminState.SelectOwnerAsync(owner);
        recentOwners = AdminState.Context.RecentOwners;
        Logger.LogInformation("Selected owner: {Owner}", owner.Email);
    }

    private void ConfirmSelection()
    {
        Navigation.NavigateTo("/admin/dashboard");
    }
}
