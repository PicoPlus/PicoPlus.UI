@page "/auth/login"

@using MudBlazor
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@using Newtonsoft.Json

@inject NavigationManager Navigation
@inject IDialogService Dialog
@inject PicoPlus.Services.CRM.Objects.Contact ContactService

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex justify-center align-center mt-8">
    <MudPaper Elevation="6" Class="pa-6 rounded-lg" Style="width:100%; max-width:400px;">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h4" Align="Align.Center" Class="font-weight-bold mb-2">
                ğŸ‘¤ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ
            </MudText>

            <MudText Typo="Typo.caption" Align="Align.Center" Class="text-secondary mb-3">
                Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ú©Ø¯ Ù…Ù„ÛŒ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ) Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ù†Ù…Ø§ÛŒÛŒØ¯
            </MudText>

            <MudTextField @bind-Value="UserID"
                          Label="Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ"
                          Variant="Variant.Filled"
                          Margin="Margin.Normal"
                          Required="true"
                          Error="@IsError"
                          ErrorText="@ErrorMessage"
                          FullWidth="true"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Person" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@IsLoading"
                       Class="mt-4"
                       FullWidth="true"
                       OnClick="@DoLogIn">
                @if (IsLoading)
                {
                    <MudProgressCircular Color="Color.Inherit" Size="Size.Small" Indeterminate="true" Class="me-2" />
                    <span>Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...</span>
                }
                else
                {
                    <span>ÙˆØ±ÙˆØ¯</span>
                }
            </MudButton>

            <MudText Typo="Typo.subtitle2" Align="Align.Center" Class="mt-3 text-muted">
                Ø­Ø³Ø§Ø¨ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ <MudLink Href="/auth/register">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯</MudLink>
            </MudText>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    public string UserID { get; set; } = string.Empty;
    public bool IsLoading { get; set; } = false;
    public bool IsError { get; set; } = false;
    public string ErrorMessage { get; set; } = string.Empty;

    public PicoPlus.Models.CRM.Objects.Contact.Search.Response.Result ContactModel { get; set; } = new()
    {
        properties = new PicoPlus.Models.CRM.Objects.Contact.Search.Response.Result.Properties()
    };

    private async Task DoLogIn()
    {
        IsError = false;
        ErrorMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(UserID))
        {
            IsError = true;
            ErrorMessage = "Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.";
            return;
        }

        IsLoading = true;

        try
        {
            bool loggedIn = await DoLogInWithNatCode() || await DoLogInWithID();

            if (loggedIn)
            {
                string jsonModel = JsonConvert.SerializeObject(ContactModel);
                await sessionStorage.SetItemAsync("ContactModel", jsonModel);
                await sessionStorage.SetItemAsync("LogInState", 1);

                Navigation.NavigateTo("/user/panel");
            }
            else
            {
                await ShowMessageBox("Ø®Ø·Ø§", "Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯.");
                Navigation.NavigateTo("/auth/register");
            }
        }
        catch (Exception ex)
        {
            await ShowMessageBox("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯", ex.Message);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task<bool> DoLogInWithNatCode()
    {
        try
        {
            string[] properties = PicoPlus.Services.Helpers.ConvertModelToStringArray(ContactModel.properties);
            var contact = await ContactService.Search("", "natcode", UserID, properties);

            if (contact.total > 0)
            {
                ContactModel = contact.results.FirstOrDefault();
                return true;
            }
            return false;
        }
        catch (Exception ex)
        {
            await ShowMessageBox("Ø®Ø·Ø§", ex.Message);
            return false;
        }
    }

    private async Task<bool> DoLogInWithID()
    {
        try
        {
            var contactSearchModel = await ContactService.Read(UserID);
            if (contactSearchModel is not null)
            {
                ContactModel = contactSearchModel;
                return true;
            }
            return false;
        }
        catch (Exception ex)
        {
            await ShowMessageBox("Ø®Ø·Ø§", ex.Message);
            return false;
        }
    }

    private async Task ShowMessageBox(string title, string message)
    {
        await Dialog.ShowMessageBox(title, message, yesText: "ØªØ£ÛŒÛŒØ¯");
        StateHasChanged();
    }
}
