@page "/auth/login"
@using Microsoft.AspNetCore.Components.Forms
@using PicoPlus.ViewModels.Auth
@inject LoginViewModel UserViewModel
@inject AdminLoginViewModel AdminViewModel
@inject NavigationManager Navigation

<link href="/css/auth.css" rel="stylesheet" />

<div class="auth-container">
    <div class="auth-card">
        
        <div class="auth-icon">
            <i class="bi bi-lock-fill"></i>
        </div>
        
        <h1 class="auth-title">خوش آمدید</h1>
        <p class="auth-subtitle">
            @(isAdminMode ? "ورود مدیر" : "کد ملی خود را وارد کنید")
        </p>

        @if (CurrentViewModel.HasError)
        {
            <div class="alert alert-danger d-flex align-items-center" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <div>@CurrentViewModel.ErrorMessage</div>
            </div>
        }

        <div class="btn-group w-100 mb-4" role="group">
            <button type="button" 
                    class="btn @(isAdminMode ? "btn-outline-primary" : "btn-primary")" 
                    @onclick="@(() => isAdminMode = false)">
                <i class="bi bi-person me-2"></i>
                ورود کاربر
            </button>
            <button type="button" 
                    class="btn @(isAdminMode ? "btn-primary" : "btn-outline-primary")" 
                    @onclick="@(() => isAdminMode = true)">
                <i class="bi bi-shield-fill-check me-2"></i>
                ورود مدیر
            </button>
        </div>

        @if (!isAdminMode)
        {
            <EditForm Model="@UserViewModel" OnValidSubmit="HandleUserLogin">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label for="nationalCode" class="form-label">کد ملی</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-credit-card"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               id="nationalCode"
                               @bind="UserViewModel.NationalCode"
                               maxlength="10"
                               disabled="@UserViewModel.IsLoading"
                               placeholder="کد ملی 10 رقمی خود را وارد کنید" />
                    </div>
                    <small class="text-muted">کد ملی 10 رقمی خود را وارد کنید</small>
                </div>

                <button type="submit"
                        class="btn btn-primary btn-lg w-100"
                        disabled="@UserViewModel.IsLoading">
                    @if (UserViewModel.IsLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>در حال ورود...</span>
                    }
                    else
                    {
                        <i class="bi bi-box-arrow-in-right me-2"></i>
                        <span>ورود به سیستم</span>
                    }
                </button>
            </EditForm>

            <hr class="my-4" />

            <div class="text-center">
                <p class="text-muted mb-0">
                    حساب کاربری ندارید؟ 
                    <a href="/auth/register" class="text-decoration-none fw-bold">ثبت نام کنید</a>
                </p>
            </div>
        }
        else
        {
            <EditForm Model="@AdminViewModel" OnValidSubmit="HandleAdminLogin">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label for="email" class="form-label">ایمیل</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-envelope"></i>
                        </span>
                        <input type="email" 
                               class="form-control" 
                               id="email"
                               @bind="AdminViewModel.Email"
                               disabled="@AdminViewModel.IsLoading"
                               placeholder="ایمیل خود را وارد کنید" />
                    </div>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">رمز عبور</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-lock"></i>
                        </span>
                        <input type="password" 
                               class="form-control" 
                               id="password"
                               @bind="AdminViewModel.Password"
                               disabled="@AdminViewModel.IsLoading"
                               placeholder="رمز عبور خود را وارد کنید" />
                    </div>
                </div>

                <div class="form-check mb-4">
                    <input class="form-check-input" 
                           type="checkbox" 
                           id="rememberMe"
                           @bind="AdminViewModel.RememberMe"
                           disabled="@AdminViewModel.IsLoading" />
                    <label class="form-check-label" for="rememberMe">
                        مرا به خاطر بسپار
                    </label>
                </div>

                <button type="submit"
                        class="btn btn-primary btn-lg w-100 mb-4"
                        disabled="@AdminViewModel.IsLoading">
                    @if (AdminViewModel.IsLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>در حال ورود...</span>
                    }
                    else
                    {
                        <i class="bi bi-box-arrow-in-right me-2"></i>
                        <span>ورود به پنل مدیریت</span>
                    }
                </button>

                <div class="alert alert-info" role="alert">
                    <strong>Demo:</strong><br />
                    ایمیل: <code>admin@picoplus.app</code><br />
                    رمز عبور: <code>Admin@123</code>
                </div>
            </EditForm>
        }
        
    </div>
</div>

@code {
    private bool isAdminMode = false;

    private IAuthBaseViewModel CurrentViewModel =>
        isAdminMode ? (IAuthBaseViewModel)AdminViewModel : UserViewModel;

    private async Task HandleUserLogin()
    {
        UserViewModel.SelectedRole = "User";
        await UserViewModel.LoginCommand.ExecuteAsync(default);
    }

    private async Task HandleAdminLogin()
    {
        await AdminViewModel.LoginCommand.ExecuteAsync(default);
    }
}
