.razor
@page "/auth/login"

@using System.Reflection
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components.Forms
@using PicoPlus.ViewModels.Auth
@inject LoginViewModel ViewModel

<link href="/css/auth.css" rel="stylesheet" />

<div class="auth-container">
    <div class="auth-card">
        <!-- Logo/Icon -->
        <div class="auth-icon">
            <i class="bi bi-shield-lock"></i>
        </div>

        <!-- Title -->
        <h1 class="auth-title">خوش آمدید</h1>
        <p class="auth-subtitle">
            لطفاً برای ورود به سامانه، اطلاعات ورود را وارد نمایید
        </p>

        <!-- Error Alert -->
        @if (ViewModel != null && ViewModel.HasError && !string.IsNullOrEmpty(ViewModel.ErrorMessage))
        {
            <div class="auth-alert auth-alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                @ViewModel.ErrorMessage
            </div>
        }

        <!-- Login Form -->
        <EditForm Model="@ViewModel" OnValidSubmit="@HandleLoginClick" class="auth-form">
            <DataAnnotationsValidator />

            <!-- Role Selection (at the top of the form) -->
            <div class="mb-4">
                <label class="form-label d-block">ورود به عنوان</label>
                <div class="role-selection">
                    <div class="form-check form-check-inline">
                        <InputRadio class="form-check-input"
                                    name="roleSelection"
                                    id="roleUser"
                                    Value="@("User")"
                                    @bind-Value=""User""
                                    disabled="@ViewModel.IsLoading" />
                        <label class="form-check-label" for="roleUser">
                            <i class="bi bi-person me-1"></i>
                            کاربر
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <InputRadio class="form-check-input"
                                    name="roleSelection"
                                    id="roleAdmin"
                                    Value="@("Admin")"
                                    @bind-Value=""User""
                                    disabled="@ViewModel.IsLoading" />
                        <label class="form-check-label" for="roleAdmin">
                            <i class="bi bi-shield-check me-1"></i>
                            مدیر
                        </label>
                    </div>
                </div>
            </div>

            <!-- Dynamic Input Fields -->
            @if ("User" == "User")
            {
                <div class="mb-4">
                    <label for="nationalCode" class="form-label">کد ملی</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-person"></i>
                        </span>
                        <InputText id="nationalCode"
                                   class="form-control"
                                   @bind-Value="@ViewModel.UserId"
                                   placeholder="کد ملی 10 رقمی"
                                   disabled="@ViewModel.IsLoading"
                                   autocomplete="username"
                                   autofocus />
                    </div>
                    <ValidationMessage For="@(() => ViewModel.UserId)" />
                    <small class="auth-helper">
                        <i class="bi bi-info-circle me-1"></i>
                        کد ملی 10 رقمی خود را وارد کنید
                    </small>
                </div>
            }
            else if ("User" == "Admin")
            {
                <div class="mb-4">
                    <label for="adminId" class="form-label">شناسه کاربری مدیر (UserId/AdminId)</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-person-badge"></i>
                        </span>
                        <InputText id="adminId"
                                   class="form-control"
                                   @bind-Value="@ViewModel.UserId"
                                   placeholder="UserId یا AdminId"
                                   disabled="@ViewModel.IsLoading"
                                   autocomplete="username"
                                   autofocus />
                    </div>
                    <ValidationMessage For="@(() => ViewModel.UserId)" />
                    <small class="auth-helper">
                        <i class="bi bi-info-circle me-1"></i>
                        شناسه کاربری مدیر (UserId یا AdminId) را وارد کنید
                    </small>
                </div>
            }

            <!-- Login Button -->
            <button type="submit" 
                    class="btn auth-btn auth-btn-primary w-100 mb-3" 
                    disabled="@ViewModel.IsLoading">
                @if (ViewModel.IsLoading)
                {
                    <span class="spinner-border spinner-border-sm auth-spinner" role="status" aria-hidden="true"></span>
                    <span>در حال ورود...</span>
                }
                else
                {
                    <i class="bi bi-box-arrow-in-left"></i>
                    <span>ورود به سامانه</span>
                }
            </button>
        </EditForm>
    </div>
</div>

@code {
    private async Task HandleLoginClick()
    {
        if (ViewModel == null)
            return;

        // Try calling a strongly-typed async method named "LoginAsync" on the view model if present
        var vmType = ViewModel.GetType();
        var loginAsyncMethod = vmType.GetMethod("LoginAsync", BindingFlags.Instance | BindingFlags.Public | BindingFlags.IgnoreCase);

        // Optional: set a flag if the view model exposes IsLoading (we already bind to it), so try to set it if available
        var isLoadingProp = vmType.GetProperty("IsLoading", BindingFlags.Instance | BindingFlags.Public | BindingFlags.IgnoreCase);

        try
        {
            if (isLoadingProp != null && isLoadingProp.CanWrite)
                isLoadingProp.SetValue(ViewModel, true);

            if (loginAsyncMethod != null)
            {
                // call LoginAsync()
                var resultTask = loginAsyncMethod.Invoke(ViewModel, null) as Task;
                if (resultTask != null)
                    await resultTask;
                return;
            }

            // If no LoginAsync, try to find a LoginCommand property and call ExecuteAsync or Execute on it
            var loginCommandProp = vmType.GetProperty("LoginCommand", BindingFlags.Instance | BindingFlags.Public | BindingFlags.IgnoreCase);
            if (loginCommandProp != null)
            {
                var cmd = loginCommandProp.GetValue(ViewModel);
                if (cmd != null)
                {
                    // Try ExecuteAsync method (common on some async command implementations)
                    var execAsync = cmd.GetType().GetMethod("ExecuteAsync", BindingFlags.Instance | BindingFlags.Public);
                    if (execAsync != null)
                    {
                        var task = execAsync.Invoke(cmd, new object[] { null }) as Task;
                        if (task != null)
                        {
                            await task;
                            return;
                        }
                    }

                    // Try plain Execute(object)
                    var exec = cmd.GetType().GetMethod("Execute", BindingFlags.Instance | BindingFlags.Public);
                    if (exec != null)
                    {
                        exec.Invoke(cmd, new object[] { null });
                        return;
                    }
                }
            }

            // If we reach here, try a method named "Login" (synchronous)
            var loginMethod = vmType.GetMethod("Login", BindingFlags.Instance | BindingFlags.Public | BindingFlags.IgnoreCase);
            if (loginMethod != null)
            {
                var ret = loginMethod.Invoke(ViewModel, null);
                // if returns a Task, await it
                if (ret is Task t) await t;
                return;
            }

            // If nothing found, throw a helpful exception (so you can see what's missing)
            throw new InvalidOperationException("ViewModel does not expose LoginAsync/Login/LoginCommand. Please add one of these methods/properties or adjust the handler.");
        }
        finally
        {
            if (isLoadingProp != null && isLoadingProp.CanWrite)
                isLoadingProp.SetValue(ViewModel, false);
        }
    }
}