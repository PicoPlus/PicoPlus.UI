<razor>
@using Microsoft.JSInterop
@inject IJSRuntime Js
@using Newtonsoft.Json
@inject IConfiguration Config
@inject PicoPlus.Services.CRM.Pipelines PiplineService
@inject PicoPlus.Services.CRM.Owners OwnerService
@inject PicoPlus.Services.CRM.Objects.Deal DealService
@inject PicoPlus.Services.CRM.Commerce.LineItem LineitemService
@inject PicoPlus.Services.SMS.SMS.Send SMSService
@inject PicoPlus.Infrastructure.Services.IDialogService DialogService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

<div class="page-content">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <BSCard Header="فرم سفارش" HeaderIcon="cart-plus-fill">
                    
                    <EditForm Model="@this" OnValidSubmit="@SubmitFinal">
                        <!-- Pipeline Selection -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="pipeline" class="form-label">کاریز</label>
                                <select class="form-select" id="pipeline" @bind="SelectedPipID" required>
                                    <option value="">-- انتخاب کنید --</option>
                                    @if (IsInit)
                                    {
                                        @foreach (var pipeline in PipList.results)
                                        {
                                            <option value="@pipeline.id">@pipeline.label</option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label for="dealStage" class="form-label">وضعیت سفارش</label>
                                <select class="form-select" id="dealStage" @bind="SelectedDealStage" required>
                                    <option value="">-- انتخاب کنید --</option>
                                    @if (IsInit && !string.IsNullOrEmpty(SelectedPipID))
                                    {
                                        @foreach (var pip in PipList.results)
                                        {
                                            if (pip.id == SelectedPipID)
                                            {
                                                @foreach (var stage in pip.stages)
                                                {
                                                    <option value="@stage.id">@stage.label</option>
                                                }
                                            }
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Deal Name -->
                        <div class="mb-4">
                            <label for="dealName" class="form-label">نام معامله</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="dealName"
                                   @bind="DealName"
                                   placeholder="عنوان سفارش"
                                   required />
                        </div>

                        <!-- Product Grid -->
                        <div class="mb-4">
                            <SeletedLineItemPane @ref="productGrid" />
                        </div>

                        <!-- Action Buttons -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-primary w-100" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>در حال ثبت...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-check-lg me-2"></i>
                                        <span>ثبت نهایی</span>
                                    }
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-danger w-100">
                                    <i class="bi bi-x-lg me-2"></i>
                                    بستن
                                </button>
                            </div>
                        </div>
                    </EditForm>

                    <BSSpinner IsLoading="@isSubmitting" Overlay="true" Message="در حال ثبت سفارش..." />
                </BSCard>
            </div>
        </div>
    </div>
</div>

@code {
    private bool IsInit { get; set; }
    private bool isSubmitting { get; set; }
    private string? ContactID { get; set; }

    [Parameter]
    public string UserID { get; set; }

    private PicoPlus.Models.CRM.Pipelines.List PipList { get; set; } = new();
    private string SelectedPipID { get; set; } = string.Empty;
    private string SelectedDealStage { get; set; } = string.Empty;

    private SeletedLineItemPane productGrid;

    private PicoPlus.Models.CRM.Owners.GetAll OwnerList { get; set; }
    private string SelectedOwner { get; set; }
    private string SelectedOwnerID { get; set; }

    private string DealName { get; set; } = string.Empty;
    private string TotalPrice { get; set; }
    private string DealAmount { get; set; }

    private List<PicoPlus.Models.CRM.Objects.Deal.Create.Request.Association> DealLines { get; set; } = new();

    public PicoPlus.Models.CRM.Objects.Contact.Search.Response.Result ContactModel { get; set; } = new()
    {
        properties = new PicoPlus.Models.CRM.Objects.Contact.Search.Response.Result.Properties()
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await LoadPiplines();
                await LoadOwners();
                IsInit = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await ShowMessageBox("خطا", ex.Message);
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var temp = await sessionStorage.GetItemAsync<string>("ContactModel");
        if (!string.IsNullOrEmpty(temp))
        {
            ContactModel = JsonConvert.DeserializeObject<PicoPlus.Models.CRM.Objects.Contact.Search.Response.Result>(temp);
            UserID = ContactModel.id;
        }
    }

    private async Task LoadPiplines()
    {
        PipList = await PiplineService.GetPipelines("deals");
    }

    private async Task LoadOwners()
    {
        OwnerList = await OwnerService.GetAll();
    }

    private async Task SubmitFinal()
    {
        if (productGrid == null) return;

        isSubmitting = true;
        try
        {
            var lineItems = productGrid.GetLineItems();
            
            if (!lineItems.Any())
            {
                await ShowMessageBox("خطا", "لطفاً حداقل یک محصول به سفارش اضافه کنید");
                return;
            }

            var lnitm = await LineitemService.CreateLineAsync(new PicoPlus.Models.CRM.Commerce.LineItem.Create.Request
            {
                inputs = lineItems
            });

            DealLines.Clear();

            // Add line items
            if (lnitm.results != null)
            {
                foreach (var line_to_deal in lnitm.results)
                {
                    DealLines.Add(new PicoPlus.Models.CRM.Objects.Deal.Create.Request.Association
                    {
                        to = new PicoPlus.Models.CRM.Objects.Deal.Create.Request.To
                        {
                            id = long.Parse(line_to_deal.id)
                        },
                        types = new List<PicoPlus.Models.CRM.Objects.Deal.Create.Request.Type>
                        {
                            new()
                            {
                                associationCategory = "HUBSPOT_DEFINED",
                                associationTypeId = 19
                            }
                        }
                    });
                }
            }

            // Add contact association
            if (!string.IsNullOrEmpty(UserID))
            {
                DealLines.Add(new PicoPlus.Models.CRM.Objects.Deal.Create.Request.Association
                {
                    to = new PicoPlus.Models.CRM.Objects.Deal.Create.Request.To
                    {
                        id = long.Parse(UserID)
                    },
                    types = new List<PicoPlus.Models.CRM.Objects.Deal.Create.Request.Type>
                    {
                        new()
                        {
                            associationCategory = "HUBSPOT_DEFINED",
                            associationTypeId = 3
                        }
                    }
                });
            }

            var deal = await DealService.Create(new PicoPlus.Models.CRM.Objects.Deal.Create.Request
            {
                properties = new PicoPlus.Models.CRM.Objects.Deal.Create.Request.Properties
                {
                    amount = productGrid.GetTotalAmount(),
                    dealname = DealName,
                    hubspot_owner_id = SelectedOwnerID,
                    dealstage = SelectedDealStage,
                    pipeline = SelectedPipID,
                },
                associations = DealLines
            });

            await ShowMessageBox("موفق", $"سفارش با موفقیت ثبت شد. شناسه: {deal.id}");

            // Send SMS if deal is closed won
            if (deal.properties.dealstage == "closedwon")
            {
                await SendClosedWonSMS(deal.id);
            }
        }
        catch (Exception ex)
        {
            await ShowMessageBox("خطا", $"خطا در ثبت سفارش: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task SendClosedWonSMS(string dealId)
    {
        try
        {
            await SMSService.SendDealClosedWon(new Models.Services.SMS.SMS.DealClosedWon
            {
                toNum = ContactModel.properties.phone,
                patternCode = "sarlemrkderzb4c",
                inputData = new List<Models.Services.SMS.SMS.DealClosedWonInputdata>
                {
                    new()
                    {
                        firstname = ContactModel.properties.firstname,
                        lastname = ContactModel.properties.lastname,
                        id = dealId
                    }
                }
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SMS Error: {ex.Message}");
        }
    }

    private async Task ShowMessageBox(string title, string message)
    {
        await DialogService.ShowMessageBoxAsync(title, message, yesText: "تأیید");
        StateHasChanged();
    }
}
</razor>
