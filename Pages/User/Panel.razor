@page "/user/panel"
@using PicoPlus.State.UserPanel
@using PicoPlus.Components.User
@using PicoPlus.Components.Shared
@using Microsoft.AspNetCore.Components.Web
@attribute [StreamRendering]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<link href="/css/user-panel.css" rel="stylesheet" />

<ErrorBoundary>
    <ChildContent>
        <!-- Top Header Bar -->
        <div class="top-header">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center py-2">
                    <div class="brand-logo">
                        <i class="bi bi-grid-fill me-2"></i>
                        <span class="fw-bold">پیکوپلاس</span>
                    </div>
                    <div class="user-info-header">
                        @if (_state?.Contact != null)
                        {
                            <div class="dropdown">
                                <button class="user-dropdown-btn" 
                                        type="button" 
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false"
                                        aria-label="منوی کاربری">
                                    <div class="user-avatar-header">
                                        @_state.Contact.GetInitials()
                                    </div>
                                    <span class="user-name-header">@_state.Contact.GetFullName()</span>
                                    <span class="user-phone-header">@(_state.Contact.Phone ?? "-")</span>
                                    <i class="bi bi-chevron-down ms-2"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow-lg modern-dropdown">
                                    <li>
                                        <button type="button" 
                                                class="dropdown-item" 
                                                @onclick="ShowProfileTab">
                                            <i class="bi bi-person me-2"></i>پروفایل من
                                        </button>
                                    </li>
                                    <li>
                                        <button type="button" 
                                                class="dropdown-item" 
                                                @onclick="ShowDealsTab">
                                            <i class="bi bi-briefcase me-2"></i>معاملات
                                        </button>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <button type="button" 
                                                class="dropdown-item text-danger" 
                                                @onclick="HandleSignOut">
                                            <i class="bi bi-box-arrow-left me-2"></i>خروج از حساب
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Dark Theme -->
        <div class="page-content-dark" dir="rtl">
            <div class="container-fluid py-4">
                
                @if (_state != null)
                {
                    <!-- Statistics Cards -->
                    <StatisticsCards 
                        Statistics="@_state.Statistics"
                        WalletBalance="@(_state.Contact.Wallet ?? 0)" />

                    <!-- Tab Navigation -->
                    <div class="modern-tabs-container fade-in" style="animation-delay: 0.5s">
                        <div class="modern-tabs" role="tablist" aria-label="بخش‌های پنل کاربری">
                            <button type="button" 
                                    class="modern-tab @(_activeTab == TabType.Profile ? "active" : "")" 
                                    @onclick="ShowProfileTab"
                                    role="tab"
                                    aria-selected="@(_activeTab == TabType.Profile)"
                                    aria-controls="profile-tab"
                                    tabindex="@(_activeTab == TabType.Profile ? 0 : -1)">
                                <i class="bi bi-person-badge-fill me-2"></i>
                                اطلاعات شخصی
                            </button>
                            <button type="button"
                                    class="modern-tab @(_activeTab == TabType.Deals ? "active" : "")" 
                                    @onclick="ShowDealsTab"
                                    role="tab"
                                    aria-selected="@(_activeTab == TabType.Deals)"
                                    aria-controls="deals-tab"
                                    tabindex="@(_activeTab == TabType.Deals ? 0 : -1)">
                                <i class="bi bi-briefcase-fill me-2"></i>
                                معاملات من (@_state.Statistics.TotalDeals)
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div class="fade-in" style="animation-delay: 0.6s">
                        @if (_activeTab == TabType.Profile)
                        {
                            <div id="profile-tab" role="tabpanel" aria-labelledby="profile-tab-button">
                                <ProfileTab Contact="@_state.Contact" />
                            </div>
                        }

                        @if (_activeTab == TabType.Deals)
                        {
                            <div id="deals-tab" role="tabpanel" aria-labelledby="deals-tab-button">
                                <DealsTable 
                                    Deals="@_state.Deals"
                                    OnDealSelected="@ShowDealDetails" />
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Deal Details Modal -->
        <DealDetailsModal 
            IsVisible="@(_selectedDeal != null)"
            Deal="@_selectedDeal"
            OnClose="@CloseDealDetails" />

        <!-- Loading Overlay -->
        <LoadingOverlay 
            IsVisible="@_isLoading"
            Message="در حال بارگذاری..." />

        <!-- Error Toast -->
        <ErrorToast 
            IsVisible="@_hasError"
            ErrorMessage="@_errorMessage"
            OnClose="@ClearError" />
    </ChildContent>
    <ErrorContent>
        <div class="page-content-dark" dir="rtl">
            <div class="container py-5">
                <EmptyState 
                    IconClass="bi-exclamation-triangle"
                    Message="خطایی در بارگذاری صفحه رخ داده است"
                    ActionText="بازگشت به صفحه ورود"
                    OnActionClick="@NavigateToLogin" />
            </div>
        </div>
    </ErrorContent>
</ErrorBoundary>
