@inherits LayoutComponentBase
@using PicoPlus.Infrastructure.Authorization
@using PicoPlus.State.Admin
@using PicoPlus.Models.Admin
@inject AdminAuthorizationHandler AuthHandler
@inject AdminStateService AdminState
@inject NavigationManager Navigation
@implements IDisposable

<div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h4 class="mb-0">
                <i class="bi bi-shield-check me-2"></i>
                ??? ??????
            </h4>
        </div>

        @if (adminInfo != null)
        {
            <div class="admin-info">
                <div class="d-flex align-items-center">
                    <div class="avatar-circle">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div class="ms-3">
                        <div class="fw-bold">@adminInfo.Name</div>
                        <small class="text-muted">@adminInfo.Role</small>
                    </div>
                </div>
            </div>
        }

        @if (selectedOwner != null)
        {
            <div class="selected-owner-info">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">?????? ????:</small>
                    <button class="btn btn-sm btn-link p-0" @onclick="ClearOwner">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <div class="owner-badge">
                    <i class="bi bi-person-badge me-2"></i>
                    <div>
                        <div class="fw-bold">@selectedOwner.FullName</div>
                        <small>@selectedOwner.Email</small>
                    </div>
                </div>
            </div>
        }

        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item @GetActiveClass("/admin/dashboard")">
                <i class="bi bi-speedometer2 me-2"></i>
                ???????
            </a>
            <a href="/admin/owner-select" class="nav-item @GetActiveClass("/admin/owner-select")">
                <i class="bi bi-person-gear me-2"></i>
                ?????? ????
            </a>
            <a href="/admin/kanban" class="nav-item @GetActiveClass("/admin/kanban")">
                <i class="bi bi-kanban me-2"></i>
                ????? ??????
            </a>
            <a href="/admin/contacts" class="nav-item @GetActiveClass("/admin/contacts")">
                <i class="bi bi-people me-2"></i>
                ???????
            </a>
            <a href="/admin/deals" class="nav-item @GetActiveClass("/admin/deals")">
                <i class="bi bi-briefcase me-2"></i>
                ???????
            </a>
            <a href="/admin/analytics" class="nav-item @GetActiveClass("/admin/analytics")">
                <i class="bi bi-graph-up me-2"></i>
                ????? ? ?????
            </a>
            <a href="/admin/settings" class="nav-item @GetActiveClass("/admin/settings")">
                <i class="bi bi-gear me-2"></i>
                ???????
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="btn btn-outline-light w-100" @onclick="HandleLogout">
                <i class="bi bi-box-arrow-left me-2"></i>
                ????
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <div class="admin-header">
            <button class="btn btn-link sidebar-toggle d-lg-none" @onclick="ToggleSidebar">
                <i class="bi bi-list fs-3"></i>
            </button>
            
            <div class="header-content">
                @if (showOwnerWarning && selectedOwner == null)
                {
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ????? ????? ?? ???? ?? ?????? ????.
                        <a href="/admin/owner-select" class="alert-link">?????? ????</a>
                    </div>
                }
            </div>
        </div>

        <div class="admin-content">
            @Body
        </div>
    </main>
</div>

@code {
    private AdminUserInfo? adminInfo;
    private HubSpotOwner? selectedOwner;
    private bool showOwnerWarning = false;
    private bool sidebarCollapsed = false;

    protected override async Task OnInitializedAsync()
    {
        // Check admin access
        var hasAccess = await AuthHandler.EnsureAdminAccessAsync();
        if (!hasAccess) return;

        // Load admin info
        adminInfo = await AuthHandler.GetAdminUserInfoAsync();

        // Initialize admin state
        await AdminState.InitializeAsync();
        selectedOwner = AdminState.GetSelectedOwner();

        // Subscribe to state changes
        AdminState.OnStateChanged += HandleStateChanged;

        // Show warning if no owner selected and not on owner select page
        CheckOwnerWarning();
    }

    private void HandleStateChanged()
    {
        selectedOwner = AdminState.GetSelectedOwner();
        CheckOwnerWarning();
        StateHasChanged();
    }

    private void CheckOwnerWarning()
    {
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        showOwnerWarning = selectedOwner == null && 
                          currentPath != "/admin/owner-select" &&
                          currentPath != "/admin/dashboard";
    }

    private async Task ClearOwner()
    {
        await AdminState.ClearSelectedOwnerAsync();
    }

    private void HandleLogout()
    {
        Navigation.NavigateTo("/auth/logout", true);
    }

    private void ToggleSidebar()
    {
        sidebarCollapsed = !sidebarCollapsed;
    }

    private string GetActiveClass(string path)
    {
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        return currentPath.StartsWith(path) ? "active" : "";
    }

    public void Dispose()
    {
        AdminState.OnStateChanged -= HandleStateChanged;
    }
}
