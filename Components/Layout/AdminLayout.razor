@inherits LayoutComponentBase
@using PicoPlus.Infrastructure.Authorization
@using PicoPlus.State.Admin
@using PicoPlus.Models.Admin
@inject AdminAuthorizationHandler AuthHandler
@inject AdminStateService AdminState
@inject NavigationManager Navigation
@implements IDisposable

<div class="admin-layout">
    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <button class="btn btn-outline-light me-3" type="button" @onclick="ToggleDrawer">
                <i class="bi bi-list"></i>
            </button>
            <span class="navbar-brand mb-0 h1">پنل مدیریت</span>
            
            @if (showOwnerWarning && selectedOwner == null)
            {
                <div class="alert alert-warning mb-0 py-1 px-3 me-auto" role="alert">
                    <small>
                        لطفاً یک مالک را انتخاب کنید.
                        <a href="/admin/owner-select" class="alert-link">انتخاب مالک</a>
                    </small>
                </div>
            }
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="admin-sidebar @(_drawerOpen ? "open" : "")">
        <div class="sidebar-header">
            <h5 class="text-primary mb-0">
                <i class="bi bi-shield-fill-check me-2"></i>
                پنل مدیریت
            </h5>
        </div>

        @if (adminInfo != null)
        {
            <hr class="my-3" />
            <div class="px-3 py-2">
                <div class="d-flex align-items-center">
                    <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 48px; height: 48px; font-size: 1.5rem;">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div>
                        <div class="fw-bold">@adminInfo.Name</div>
                        <small class="text-muted">@adminInfo.Role</small>
                    </div>
                </div>
            </div>
        }

        @if (selectedOwner != null)
        {
            <hr class="my-3" />
            <div class="px-3 py-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">مالک فعال:</small>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ClearOwner">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="card">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person-badge text-primary me-2"></i>
                            <div>
                                <div class="small fw-bold">@selectedOwner.FullName</div>
                                <small class="text-muted">@selectedOwner.Email</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <hr class="my-3" />
        
        <!-- Navigation Menu -->
        <nav class="nav flex-column px-2">
            <a class="nav-link @GetNavLinkClass("/admin/dashboard")" href="/admin/dashboard">
                <i class="bi bi-speedometer2 me-2"></i>
                داشبورد
            </a>
            <a class="nav-link @GetNavLinkClass("/admin/owner-select")" href="/admin/owner-select">
                <i class="bi bi-person-gear me-2"></i>
                انتخاب مالک
            </a>
            <a class="nav-link @GetNavLinkClass("/admin/kanban")" href="/admin/kanban">
                <i class="bi bi-kanban me-2"></i>
                بورد کانبان
            </a>
            <a class="nav-link @GetNavLinkClass("/admin/contacts")" href="/admin/contacts">
                <i class="bi bi-people me-2"></i>
                مخاطبین
            </a>
            <a class="nav-link @GetNavLinkClass("/admin/deals")" href="/admin/deals">
                <i class="bi bi-briefcase me-2"></i>
                معاملات
            </a>
            <a class="nav-link @GetNavLinkClass("/admin/analytics")" href="/admin/analytics">
                <i class="bi bi-graph-up-arrow me-2"></i>
                گزارش و تحلیل
            </a>
            <a class="nav-link @GetNavLinkClass("/admin/settings")" href="/admin/settings">
                <i class="bi bi-gear me-2"></i>
                تنظیمات
            </a>
        </nav>

        <!-- Logout Button at Bottom -->
        <div class="mt-auto p-3">
            <button class="btn btn-outline-danger w-100" @onclick="HandleLogout">
                <i class="bi bi-box-arrow-right me-2"></i>
                خروج
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="admin-content @(_drawerOpen ? "sidebar-open" : "")">
        <div class="container-fluid py-4">
            @Body
        </div>
    </main>
</div>

<style>
    .admin-layout {
        display: flex;
        min-height: 100vh;
        padding-top: 56px;
    }

    .admin-sidebar {
        position: fixed;
        top: 56px;
        right: 0;
        bottom: 0;
        width: 280px;
        background: white;
        border-left: 1px solid #dee2e6;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        overflow-y: auto;
        z-index: 1000;
        display: flex;
        flex-direction: column;
    }

    .admin-sidebar.open {
        transform: translateX(0);
    }

    .sidebar-header {
        padding: 1.5rem 1rem;
    }

    .admin-sidebar .nav-link {
        color: #495057;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        margin: 0.125rem 0;
        transition: all 0.2s;
    }

    .admin-sidebar .nav-link:hover {
        background-color: #f8f9fa;
        color: #0d6efd;
    }

    .admin-sidebar .nav-link.active {
        background-color: #0d6efd;
        color: white;
    }

    .admin-sidebar .nav-link i {
        width: 20px;
    }

    .admin-content {
        flex: 1;
        margin-right: 0;
        transition: margin-right 0.3s ease;
    }

    .admin-content.sidebar-open {
        margin-right: 280px;
    }

    .avatar {
        flex-shrink: 0;
    }

    @@media (max-width: 768px) {
        .admin-sidebar {
            width: 100%;
        }

        .admin-content.sidebar-open {
            margin-right: 0;
        }
    }
</style>

@code {
    private bool _drawerOpen = true;
    private AdminUserInfo? adminInfo;
    private HubSpotOwner? selectedOwner;
    private bool showOwnerWarning = false;

    protected override async Task OnInitializedAsync()
    {
        // Check admin access
        var hasAccess = await AuthHandler.EnsureAdminAccessAsync();
        if (!hasAccess) return;

        // Load admin info
        adminInfo = await AuthHandler.GetAdminUserInfoAsync();

        // Initialize admin state
        await AdminState.InitializeAsync();
        selectedOwner = AdminState.GetSelectedOwner();

        // Subscribe to state changes
        AdminState.OnStateChanged += HandleStateChanged;

        // Show warning if no owner selected and not on owner select page
        CheckOwnerWarning();
    }

    private void HandleStateChanged()
    {
        selectedOwner = AdminState.GetSelectedOwner();
        CheckOwnerWarning();
        StateHasChanged();
    }

    private void CheckOwnerWarning()
    {
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        showOwnerWarning = selectedOwner == null && 
                          currentPath != "/admin/owner-select" &&
                          currentPath != "/admin/dashboard";
    }

    private async Task ClearOwner()
    {
        await AdminState.ClearSelectedOwnerAsync();
    }

    private void HandleLogout()
    {
        Navigation.NavigateTo("/auth/logout", true);
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private string GetNavLinkClass(string href)
    {
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        return currentPath == href ? "active" : "";
    }

    public void Dispose()
    {
        AdminState.OnStateChanged -= HandleStateChanged;
    }
}
