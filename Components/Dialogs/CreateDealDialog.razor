@using Microsoft.AspNetCore.Components.Forms
@using PicoPlus.ViewModels.Deal
@using PicoPlus.Views
@inject DealCreateDialogViewModel ViewModel
@implements IAsyncDisposable

@if (IsVisible)
{
    <div class="modal-overlay" @onclick="HandleOverlayClick">
        <div class="modal-dark modal-lg" @onclick:stopPropagation="true">
            <div class="modal-dark-header">
                <h5 class="modal-dark-title">
                    <i class="bi bi-briefcase-fill me-2"></i>
                    ایجاد معامله جدید
                </h5>

                <button type="button" class="btn-close-dark" @onclick="HandleCancel">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <EditForm Model="@ViewModel" OnValidSubmit="@HandleSubmit">
                <DataAnnotationsValidator />

                <div class="modal-dark-body" dir="rtl">

                    @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            @ViewModel.ErrorMessage
                        </div>
                    }

                    <div class="row g-3">

                        <!-- Deal Name -->
                        <div class="col-12">
                            <label class="dark-label">
                                <i class="bi bi-tag me-2"></i>نام معامله <span class="text-danger">*</span>
                            </label>

                            <InputText class="dark-input persian-text"
                                       @bind-Value="ViewModel.DealName"
                                       placeholder="مثلاً خرید سرویس جدید"
                                       disabled="@ViewModel.IsLoading" />
                            <ValidationMessage For="@(() => ViewModel.DealName)" />
                        </div>

                        <!-- Pipeline -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-diagram-3 me-2"></i>پایپ‌لاین <span class="text-danger">*</span>
                            </label>

                            <InputSelect class="dark-input"
                                         @bind-Value="ViewModel.SelectedPipelineId"
                                         disabled="@ViewModel.IsLoading">
                                <option value="">-- انتخاب کنید --</option>

                                @if (ViewModel.Pipelines is not null)
                                {
                                    @foreach (var pipeline in ViewModel.Pipelines)
                                    {
                                        <option value="@pipeline.id">@pipeline.label</option>
                                    }
                                }
                            </InputSelect>

                            <ValidationMessage For="@(() => ViewModel.SelectedPipelineId)" />
                        </div>

                        <!-- Deal Stage -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-flag me-2"></i>مرحله معامله <span class="text-danger">*</span>
                            </label>

                            <InputSelect class="dark-input"
                                         @bind-Value="ViewModel.SelectedDealStage"
                                         disabled="@(ViewModel.IsLoading || string.IsNullOrEmpty(ViewModel.SelectedPipelineId))">
                                <option value="">-- انتخاب کنید --</option>

                                @if (ViewModel.DealStages is not null)
                                {
                                    @foreach (var stage in ViewModel.DealStages)
                                    {
                                        <option value="@stage.id">@stage.label</option>
                                    }
                                }
                            </InputSelect>

                            <ValidationMessage For="@(() => ViewModel.SelectedDealStage)" />
                        </div>

                        <!-- Description -->
                        <div class="col-12">
                            <label class="dark-label">
                                <i class="bi bi-text-paragraph me-2"></i>توضیحات
                            </label>

                            <InputTextArea class="dark-input persian-text"
                                           @bind-Value="ViewModel.Description"
                                           placeholder="توضیحات معامله (دلخواه)"
                                           rows="3"
                                           disabled="@ViewModel.IsLoading" />
                        </div>

                        <!-- Close Date -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-calendar-check me-2"></i>تاریخ بستن
                            </label>

                            <InputDate class="dark-input"
                                       @bind-Value="ViewModel.CloseDate"
                                       disabled="@ViewModel.IsLoading" />
                        </div>

                        <!-- Amount -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-cash-coin me-2"></i>مبلغ معامله (ریال)
                            </label>

                            <InputNumber class="dark-input"
                                         @bind-Value="ViewModel.Amount"
                                         placeholder="0"
                                         disabled="@ViewModel.IsLoading" />
                        </div>

                        <!-- Owner -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-person-badge me-2"></i>مالک معامله <span class="text-danger">*</span>
                            </label>

                            <InputSelect class="dark-input"
                                         @bind-Value="ViewModel.SelectedOwnerId"
                                         disabled="@ViewModel.IsLoading">
                                <option value="">-- انتخاب کنید --</option>

                                @if (ViewModel.Owners is not null)
                                {
                                    @foreach (var owner in ViewModel.Owners)
                                    {
                                        <option value="@owner.id">@($"{owner.firstName} {owner.lastName}")</option>
                                    }
                                }
                            </InputSelect>

                            <ValidationMessage For="@(() => ViewModel.SelectedOwnerId)" />
                        </div>

                        <!-- Tax -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-receipt me-2"></i>مالیات (ریال)
                            </label>

                            <InputNumber class="dark-input"
                                         @bind-Value="ViewModel.TaxAmount"
                                         placeholder="0"
                                         disabled="@ViewModel.IsLoading" />
                        </div>

                        <!-- Deal Type -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-box-seam me-2"></i>نوع معامله
                            </label>

                            <InputSelect class="dark-input"
                                         @bind-Value="ViewModel.DealType"
                                         disabled="@ViewModel.IsLoading">
                                <option value="">-- انتخاب کنید --</option>
                                <option value="newbusiness">جدید</option>
                                <option value="existingbusiness">مشتری فعلی</option>
                                <option value="renewal">تمدید</option>
                                <option value="upgrade">ارتقاء</option>
                            </InputSelect>
                        </div>

                        <!-- Priority -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-exclamation-diamond me-2"></i>اولویت
                            </label>

                            <InputSelect class="dark-input"
                                         @bind-Value="ViewModel.Priority"
                                         disabled="@ViewModel.IsLoading">
                                <option value="">-- انتخاب کنید --</option>
                                <option value="low">کم</option>
                                <option value="medium">متوسط</option>
                                <option value="high">زیاد</option>
                            </InputSelect>
                        </div>

                        <!-- Associate With Contact -->
                        <div class="col-12">
                            <div class="info-box-dark">
                                <label class="dark-label mb-2">
                                    <i class="bi bi-person-lines-fill me-2"></i>ارتباط با مخاطب
                                </label>

                                @if (!string.IsNullOrEmpty(ContactName))
                                {
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-info">
                                            <i class="bi bi-person-check me-1"></i>
                                            @ContactName
                                        </span>
                                        <small class="text-muted">
                                            این معامله به @ContactName متصل خواهد شد
                                        </small>
                                    </div>
                                }
                                else
                                {
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        هنوز مخاطبی انتخاب نشده است
                                    </small>
                                }
                            </div>
                        </div>

                        <!-- Line Items -->
                        <div class="col-12">
                            <div class="line-item-section">
                                <label class="dark-label mb-3">
                                    <i class="bi bi-list-ul me-2"></i>آیتم‌های معامله
                                </label>
                                <SeletedLineItemPane @ref="lineItemPane" />
                            </div>
                        </div>

                    </div>
                </div>

                <div class="modal-dark-footer">
                    <button type="button"
                            class="btn-secondary-dark"
                            @onclick="HandleCancel"
                            disabled="@ViewModel.IsLoading">
                        <i class="bi bi-x-lg me-2"></i>لغو
                    </button>

                    <button type="submit"
                            class="btn-primary-dark"
                            disabled="@ViewModel.IsLoading">

                        @if (ViewModel.IsLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>در حال ذخیره...</span>
                        }
                        else
                        {
                            <i class="bi bi-check-circle me-2"></i>
                            <span>ثبت معامله</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string? ContactId { get; set; }
    [Parameter] public string? ContactName { get; set; }
    [Parameter] public EventCallback<string> OnDealCreated { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private SeletedLineItemPane? lineItemPane;
    private string? lastLoadedContactId;

    protected override async Task OnParametersSetAsync()
    {
        // Only reinitialize when component becomes visible OR contact changes
        if (IsVisible && ContactId != lastLoadedContactId)
        {
            lastLoadedContactId = ContactId;
            await ViewModel.InitializeAsync(ContactId);
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (lineItemPane is not null)
                ViewModel.LineItems = lineItemPane.GetLineItems();

            var dealId = await ViewModel.CreateDealAsync();

            if (!string.IsNullOrEmpty(dealId))
                await OnDealCreated.InvokeAsync(dealId);
        }
        catch (Exception ex)
        {
            // This prevents silent UI failures
            ViewModel.ErrorMessage = "خطا در ذخیره معامله: " + ex.Message;
        }
    }

    private async Task HandleCancel() => await OnCancel.InvokeAsync();

    private async Task HandleOverlayClick()
    {
        if (!ViewModel.IsLoading)
            await HandleCancel();
    }

    public async ValueTask DisposeAsync()
    {
        await Task.CompletedTask;
    }
}
