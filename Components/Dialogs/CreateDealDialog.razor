@using Microsoft.AspNetCore.Components.Forms
@using PicoPlus.ViewModels.Deal
@using PicoPlus.Views
@inject DealCreateDialogViewModel ViewModel
@implements IAsyncDisposable

@if (IsVisible)
{
    <div class="modal-overlay" @onclick="HandleOverlayClick">
        <div class="modal-dark modal-lg" @onclick:stopPropagation="true">
            <div class="modal-dark-header">
                <h5 class="modal-dark-title">
                    <i class="bi bi-briefcase-fill me-2"></i>
                    ????? ?????? ????
                </h5>
                <button type="button" class="btn-close-dark" @onclick="HandleCancel">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <EditForm Model="@ViewModel" OnValidSubmit="@HandleSubmit">
                <DataAnnotationsValidator />
                
                <div class="modal-dark-body" dir="rtl">
                    @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            @ViewModel.ErrorMessage
                        </div>
                    }

                    <div class="row g-3">
                        <!-- Deal Name -->
                        <div class="col-12">
                            <label class="dark-label">
                                <i class="bi bi-tag me-2"></i>????? ?????? <span class="text-danger">*</span>
                            </label>
                            <InputText class="dark-input persian-text" 
                                       @bind-Value="ViewModel.DealName"
                                       placeholder="??????? ?????? ?? ???? ????"
                                       disabled="@ViewModel.IsLoading" />
                            <ValidationMessage For="@(() => ViewModel.DealName)" />
                        </div>

                        <!-- Pipeline -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-diagram-3 me-2"></i>????? (Pipeline) <span class="text-danger">*</span>
                            </label>
                            <InputSelect class="dark-input" 
                                         @bind-Value="ViewModel.SelectedPipelineId"
                                         disabled="@ViewModel.IsLoading">
                                <option value="">-- ?????? ???? --</option>
                                @if (ViewModel.Pipelines != null)
                                {
                                    @foreach (var pipeline in ViewModel.Pipelines)
                                    {
                                        <option value="@pipeline.id">@pipeline.label</option>
                                    }
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => ViewModel.SelectedPipelineId)" />
                        </div>

                        <!-- Deal Stage -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-flag me-2"></i>??????? ?????? <span class="text-danger">*</span>
                            </label>
                            <InputSelect class="dark-input" 
                                         @bind-Value="ViewModel.SelectedDealStage"
                                         disabled="@(ViewModel.IsLoading || string.IsNullOrEmpty(ViewModel.SelectedPipelineId))">
                                <option value="">-- ?????? ???? --</option>
                                @if (ViewModel.DealStages != null)
                                {
                                    @foreach (var stage in ViewModel.DealStages)
                                    {
                                        <option value="@stage.id">@stage.label</option>
                                    }
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => ViewModel.SelectedDealStage)" />
                        </div>

                        <!-- Deal Description -->
                        <div class="col-12">
                            <label class="dark-label">
                                <i class="bi bi-text-paragraph me-2"></i>????????? ??????
                            </label>
                            <InputTextArea class="dark-input persian-text" 
                                           @bind-Value="ViewModel.Description"
                                           placeholder="????????? ?????? (??????)"
                                           rows="3"
                                           disabled="@ViewModel.IsLoading" />
                        </div>

                        <!-- Close Date -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-calendar-check me-2"></i>????? ???? ???
                            </label>
                            <InputDate class="dark-input" 
                                       @bind-Value="ViewModel.CloseDate"
                                       disabled="@ViewModel.IsLoading" />
                            <small class="text-muted">????? ?????? ???? ????? ??????</small>
                        </div>

                        <!-- Amount -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-cash-coin me-2"></i>?????? ?????? (??)
                            </label>
                            <InputNumber class="dark-input" 
                                         @bind-Value="ViewModel.Amount"
                                         placeholder="0"
                                         disabled="@ViewModel.IsLoading" />
                            <small class="text-muted">?????? ???????? ????? ??????</small>
                        </div>

                        <!-- Deal Owner -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-person-badge me-2"></i>??????? ?????? <span class="text-danger">*</span>
                            </label>
                            <InputSelect class="dark-input" 
                                         @bind-Value="ViewModel.SelectedOwnerId"
                                         disabled="@ViewModel.IsLoading">
                                <option value="">-- ?????? ???? --</option>
                                @if (ViewModel.Owners != null)
                                {
                                    @foreach (var owner in ViewModel.Owners)
                                    {
                                        <option value="@owner.id">@($"{owner.firstName} {owner.lastName}")</option>
                                    }
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => ViewModel.SelectedOwnerId)" />
                        </div>

                        <!-- Tax Amount -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-receipt me-2"></i>?????? ?????? (??)
                            </label>
                            <InputNumber class="dark-input" 
                                         @bind-Value="ViewModel.TaxAmount"
                                         placeholder="0"
                                         disabled="@ViewModel.IsLoading" />
                            <small class="text-muted">????? ?????? ??????</small>
                        </div>

                        <!-- Deal Type -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-box-seam me-2"></i>????? ??????
                            </label>
                            <InputSelect class="dark-input" 
                                         @bind-Value="ViewModel.DealType"
                                         disabled="@ViewModel.IsLoading">
                                <option value="">-- ?????? ???? --</option>
                                <option value="newbusiness">??? ? ??? ????</option>
                                <option value="existingbusiness">??? ? ??? ?????</option>
                                <option value="renewal">??????? ???????</option>
                                <option value="upgrade">?????</option>
                            </InputSelect>
                        </div>

                        <!-- Priority -->
                        <div class="col-md-6">
                            <label class="dark-label">
                                <i class="bi bi-exclamation-diamond me-2"></i>?????
                            </label>
                            <InputSelect class="dark-input" 
                                         @bind-Value="ViewModel.Priority"
                                         disabled="@ViewModel.IsLoading">
                                <option value="">-- ?????? ???? --</option>
                                <option value="low">??</option>
                                <option value="medium">??</option>
                                <option value="high">????</option>
                            </InputSelect>
                        </div>

                        <!-- Associate Deal With Contact -->
                        <div class="col-12">
                            <div class="info-box-dark">
                                <label class="dark-label mb-2">
                                    <i class="bi bi-person-lines-fill me-2"></i>????? ?? ??
                                </label>
                                @if (!string.IsNullOrEmpty(ContactName))
                                {
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-info">
                                            <i class="bi bi-person-check me-1"></i>
                                            @ContactName
                                        </span>
                                        <small class="text-muted">????? ?????? ?? @ContactName ???? ?? ??</small>
                                    </div>
                                }
                                else
                                {
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        ??? ?????? ?????? ???? ???
                                    </small>
                                }
                            </div>
                        </div>

                        <!-- Add Line Items Section -->
                        <div class="col-12">
                            <div class="line-item-section">
                                <label class="dark-label mb-3">
                                    <i class="bi bi-list-ul me-2"></i>??????? ?????? (Line Items)
                                </label>
                                <SeletedLineItemPane @ref="lineItemPane" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-dark-footer">
                    <button type="button" 
                            class="btn-secondary-dark" 
                            @onclick="HandleCancel"
                            disabled="@ViewModel.IsLoading">
                        <i class="bi bi-x-lg me-2"></i>?????
                    </button>
                    <button type="submit" 
                            class="btn-primary-dark" 
                            disabled="@ViewModel.IsLoading">
                        @if (ViewModel.IsLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>?? ??? ??...</span>
                        }
                        else
                        {
                            <i class="bi bi-check-circle me-2"></i>
                            <span>??????? ??????</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public string? ContactId { get; set; }

    [Parameter]
    public string? ContactName { get; set; }

    [Parameter]
    public EventCallback<string> OnDealCreated { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private SeletedLineItemPane lineItemPane;

    protected override async Task OnInitializedAsync()
    {
        await ViewModel.InitializeAsync(ContactId);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !string.IsNullOrEmpty(ContactId))
        {
            await ViewModel.InitializeAsync(ContactId);
        }
    }

    private async Task HandleSubmit()
    {
        if (lineItemPane != null)
        {
            ViewModel.LineItems = lineItemPane.GetLineItems();
        }
        var dealId = await ViewModel.CreateDealAsync();
        if (!string.IsNullOrEmpty(dealId))
        {
            await OnDealCreated.InvokeAsync(dealId);
        }
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }

    private async Task HandleOverlayClick()
    {
        if (!ViewModel.IsLoading)
        {
            await HandleCancel();
        }
    }

    public async ValueTask DisposeAsync()
    {
        // Cleanup if needed
        await Task.CompletedTask;
    }
}
