@page "/auth/login"
@using Microsoft.AspNetCore.Components.Forms
@using PicoPlus.Application.Abstractions.Services
@inject PicoPlus.Application.Abstractions.Auth.IAuthService AuthService
@inject ISessionStorageService SessionStorage

<link href="/css/auth.css" rel="stylesheet" />

<div class="auth-container">
    <div class="auth-card">
        <h1 class="auth-title">ورود</h1>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="auth-alert auth-alert-danger" role="alert">@_error</div>
        }

        <div class="mb-4">
            <div class="role-tabs">
                <button type="button" class="role-tab @(!_isAdmin ? "active" : "")" @onclick="() => _isAdmin = false">کاربر</button>
                <button type="button" class="role-tab @(_isAdmin ? "active" : "")" @onclick="() => _isAdmin = true">مدیر</button>
            </div>
        </div>

        @if (_isAdmin)
        {
            <EditForm OnValidSubmit="LoginAdminAsync" class="auth-form">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <InputText class="form-control" @bind-Value="_adminEmail" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <InputText type="password" class="form-control" @bind-Value="_adminPassword" />
                </div>
                <button type="submit" class="btn auth-btn auth-btn-primary w-100">ورود مدیر</button>
            </EditForm>
        }
        else
        {
            <EditForm OnValidSubmit="LoginUserAsync" class="auth-form">
                <div class="mb-3">
                    <label class="form-label">کد ملی</label>
                    <InputText class="form-control" @bind-Value="_nationalCode" maxlength="10" />
                </div>
                <button type="submit" class="btn auth-btn auth-btn-primary w-100">ورود کاربر</button>
            </EditForm>

            <div class="text-center mt-3">
                <a href="/auth/register" class="auth-link">ثبت نام</a>
            </div>
        }
    </div>
</div>

@code {
    private bool _isAdmin;
    private string _adminEmail = string.Empty;
    private string _adminPassword = string.Empty;
    private string _nationalCode = string.Empty;
    private string? _error;

    private async Task LoginAdminAsync()
    {
        _error = null;

        if (_adminEmail != "admin@picoplus.app" || _adminPassword != "Admin@123")
        {
            _error = "اطلاعات مدیر نامعتبر است.";
            return;
        }

        await SessionStorage.SetItemAsync("LogInState", 1);
        await AuthService.NavigateByRoleAsync("Admin", persist: true);
    }

    private async Task LoginUserAsync()
    {
        _error = null;

        if (string.IsNullOrWhiteSpace(_nationalCode) || _nationalCode.Length != 10)
        {
            _error = "کد ملی باید ۱۰ رقم باشد.";
            return;
        }

        await SessionStorage.SetItemAsync("LogInState", 1);
        await AuthService.NavigateByRoleAsync("User");
    }
}
